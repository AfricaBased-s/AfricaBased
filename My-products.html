<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Investments | AfricaBased</title>
    <script type="module" src="js/supabaseClient.js"></script>
    <script type="module" src="js/auth.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #232526 0%, #414345 100%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 32px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .summary-container {
            background: rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
            border: 1px solid rgba(78, 205, 196, 0.2);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 24px;
            margin-top: 16px;
        }

        .summary-box {
            background: rgba(255,255,255,0.04);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .summary-label {
            color: #ffd54f;
            font-size: 0.9rem;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .summary-value {
            color: #4ecdc4;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .investment-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 32px;
        }

        .investment-card {
            background: rgba(255,255,255,0.08);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid rgba(78, 205, 196, 0.2);
            transition: all 0.3s ease;
        }

        .investment-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 24px rgba(78, 205, 196, 0.15);
            border-color: rgba(78, 205, 196, 0.4);
        }

        .investment-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .investment-details {
            padding: 20px;
        }

        .investment-title {
            color: #fff;
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .investment-sector {
            color: #b39ddb;
            font-size: 0.9rem;
            margin-bottom: 16px;
        }

        .investment-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }

        .info-box {
            background: rgba(255,255,255,0.04);
            border-radius: 6px;
            padding: 12px;
            text-align: center;
        }

        .info-label {
            color: #ffd54f;
            font-size: 0.8rem;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .info-value {
            color: #80cbc4;
            font-size: 1rem;
            font-weight: 500;
        }

        .progress-container {
            margin-top: 16px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            color: #fff;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #4ecdc4, #45b7af);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .back-btn-container {
            position: absolute;
            top: 24px;
            left: 32px;
            z-index: 10;
        }

        .back-btn {
            background: linear-gradient(45deg, #4ecdc4, #ff6b6b);
            color: #fff;
            border: none;
            padding: 10px 22px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(78,205,196,0.10);
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: #fff;
            color: #4ecdc4;
            box-shadow: 0 4px 16px rgba(78,205,196,0.18);
            transform: translateY(-1px);
        }

        h1 {
            color: #4ecdc4;
            text-align: center;
            margin-bottom: 32px;
        }

        .empty-state {
            text-align: center;
            padding: 48px 20px;
            color: #fff;
        }

        .empty-state h2 {
            color: #4ecdc4;
            margin-bottom: 16px;
        }

        .empty-state p {
            color: #b39ddb;
            margin-bottom: 24px;
        }

        .invest-btn {
            background: linear-gradient(45deg, #4ecdc4, #ff6b6b);
            color: #fff;
            border: none;
            padding: 12px 32px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .invest-btn:hover {
            background: #fff;
            color: #4ecdc4;
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(78,205,196,0.18);
        }

        .earnings-box {
            background: linear-gradient(135deg, rgba(78,205,196,0.1), rgba(255,213,79,0.1));
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            border: 1px solid rgba(78,205,196,0.2);
        }

        .earnings-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .earnings-item {
            text-align: center;
        }

        .earnings-label {
            color: #ffd54f;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }

        .earnings-value {
            color: #4ecdc4;
            font-size: 1.1rem;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="back-btn-container">
        <button class="back-btn" onclick="window.history.back()">&#8592; Back</button>
    </div>

    <div class="container">
        <h1>My Investments</h1>
        
        <div class="summary-container">
            <div class="summary-grid">
                <div class="summary-box">
                    <div class="summary-label">Total Invested</div>
                    <div class="summary-value" id="total-invested">Ksh 0</div>
                </div>
                <div class="summary-box">
                    <div class="summary-label">Total Daily Returns</div>
                    <div class="summary-value" id="total-daily-returns">Ksh 0</div>
                </div>
                <div class="summary-box">
                    <div class="summary-label">Active Investments</div>
                    <div class="summary-value" id="active-investments">0</div>
                </div>
                <div class="summary-box">
                    <div class="summary-label">Total Earnings</div>
                    <div class="summary-value" id="total-earnings">Ksh 0</div>
                </div>
            </div>
        </div>

        <div id="investments-container" class="investment-cards">
            <!-- Investment cards will be dynamically inserted here -->
        </div>

        <div id="empty-state" class="empty-state" style="display: none;">
            <h2>No Investments Yet</h2>
            <p>Start your investment journey by exploring our available products</p>
            <a href="products.complete.html" class="invest-btn">Explore Investments</a>
        </div>
    </div>

    <script type="module">
        // Import Supabase client
        import { supabase } from './js/supabaseClient.js';
        
        // Format currency helper
        function formatCurrency(amount) {
            return 'Ksh ' + amount.toLocaleString();
        }

        function calculateDaysBetween(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        // Get current user session
        async function getCurrentUser() {
            const { data: { user }, error } = await supabase.auth.getUser();
            if (error) {
                console.error('Error getting user:', error.message);
                window.location.href = 'login.html';
                return null;
            }
            return user;
        }

        function calculateProgress(startDate, duration) {
            const start = new Date(startDate);
            const now = new Date();
            const totalDays = parseInt(duration.split(' ')[0]);
            const daysPassed = calculateDaysBetween(start, now);
            return Math.min((daysPassed / totalDays) * 100, 100);
        }

        function calculateEarnings(dailyReturns, startDate) {
            const daysPassed = calculateDaysBetween(startDate, new Date());
            const returns = parseFloat(dailyReturns.split(' ')[1]);
            return returns * daysPassed;
        }

        function updateSummary(investments) {
            let totalInvested = 0;
            let totalDailyReturns = 0;
            let totalEarnings = 0;

            investments.forEach(investment => {
                totalInvested += investment.investment;
                totalDailyReturns += parseFloat(investment.dailyReturns.split(' ')[1]);
                totalEarnings += calculateEarnings(investment.dailyReturns, investment.investmentDate);
            });

            document.getElementById('total-invested').textContent = formatCurrency(totalInvested);
            document.getElementById('total-daily-returns').textContent = formatCurrency(totalDailyReturns);
            document.getElementById('active-investments').textContent = investments.length;
            document.getElementById('total-earnings').textContent = formatCurrency(totalEarnings);
        }

        async function displayInvestments() {
            const user = await getCurrentUser();
            if (!user) return;

            // Fetch user's investments from Supabase
            const { data: investments, error } = await supabase
                .from('investments')
                .select('*')
                .eq('user_id', user.id);

            if (error) {
                console.error('Error fetching investments:', error.message);
                return;
            }

            const container = document.getElementById('investments-container');
            const emptyState = document.getElementById('empty-state');

            if (!investments || investments.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            container.style.display = 'grid';
            emptyState.style.display = 'none';
            container.innerHTML = '';

            investments.forEach(investment => {
                const progress = calculateProgress(investment.investmentDate, investment.duration);
                const earnings = calculateEarnings(investment.dailyReturns, investment.investmentDate);
                const daysLeft = parseInt(investment.duration.split(' ')[0]) - 
                                calculateDaysBetween(investment.investmentDate, new Date());

                const card = document.createElement('div');
                card.className = 'investment-card';
                card.innerHTML = `
                    <img src="${investment.image}" alt="${investment.name}" class="investment-image">
                    <div class="investment-details">
                        <div class="investment-title">${investment.name}</div>
                        <div class="investment-sector">Sector: ${investment.sector}</div>
                        
                        <div class="investment-info-grid">
                            <div class="info-box">
                                <div class="info-label">Investment Amount</div>
                                <div class="info-value">${formatCurrency(investment.investment)}</div>
                            </div>
                            <div class="info-box">
                                <div class="info-label">Daily Returns</div>
                                <div class="info-value">${investment.dailyReturns}</div>
                            </div>
                        </div>

                        <div class="earnings-box">
                            <div class="earnings-grid">
                                <div class="earnings-item">
                                    <div class="earnings-label">Total Earnings</div>
                                    <div class="earnings-value">${formatCurrency(earnings)}</div>
                                </div>
                                <div class="earnings-item">
                                    <div class="earnings-label">Days Remaining</div>
                                    <div class="earnings-value">${Math.max(0, daysLeft)} days</div>
                                </div>
                            </div>
                            <div class="collect-section" style="margin-top: 16px; text-align: center;">
                                <div class="info-label" style="margin-bottom: 8px;">Next Collection In</div>
                                <div class="info-value countdown-timer" data-investment-id="${investment.id}">Calculating...</div>
                                <button class="collect-btn" 
                                    onclick="collectDailyReturns('${investment.id}')"
                                    data-investment-id="${investment.id}"
                                    style="
                                        background: linear-gradient(45deg, #4ecdc4, #45b7af);
                                        color: #fff;
                                        border: none;
                                        padding: 8px 24px;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        font-size: 0.9rem;
                                        font-weight: 600;
                                        margin-top: 8px;
                                        width: 100%;
                                        transition: all 0.3s ease;
                                    "
                                    disabled
                                >
                                    Collect Daily Returns
                                </button>
                            </div>
                        </div>

                        <div class="progress-container">
                            <div class="progress-label">
                                <span>Investment Progress</span>
                                <span>${Math.min(100, Math.round(progress))}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progress}%"></div>
                            </div>
                        </div>
                    </div>
                `;

                container.appendChild(card);
            });

            updateSummary(investments);
            updateCollectionTimers();
        }

        async function updateCollectionTimers() {
            const user = await getCurrentUser();
            if (!user) return;

            // Fetch all investments and their last collections
            const { data: investments, error: investError } = await supabase
                .from('investments')
                .select(`
                    *,
                    collections (
                        collected_at
                    )
                `)
                .eq('user_id', user.id);

            if (investError) {
                console.error('Error fetching investment data:', investError.message);
                return;
            }

            investments.forEach(investment => {
                const lastCollection = investment.collections && investment.collections.length > 0 
                    ? Math.max(...investment.collections.map(c => new Date(c.collected_at).getTime()))
                    : new Date(investment.created_at).getTime();
                const nextCollectionTime = lastCollection + (24 * 60 * 60 * 1000);
                const now = new Date().getTime();
                const timeLeft = nextCollectionTime - now;

                const timerElement = document.querySelector(`.countdown-timer[data-investment-id="${investment.id}"]`);
                const collectButton = document.querySelector(`.collect-btn[data-investment-id="${investment.id}"]`);
                
                if (timeLeft <= 0) {
                    timerElement.textContent = 'Ready to Collect!';
                    collectButton.disabled = false;
                    collectButton.style.opacity = '1';
                } else {
                    const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                    
                    timerElement.textContent = `${hours}h ${minutes}m ${seconds}s`;
                    collectButton.disabled = true;
                    collectButton.style.opacity = '0.5';
                }
            });
        }

        async function collectDailyReturns(investmentId) {
            const user = await getCurrentUser();
            if (!user) return;

            // Start a Supabase transaction to collect daily returns
            const { data: investment, error: fetchError } = await supabase
                .from('investments')
                .select('*')
                .eq('id', investmentId)
                .eq('user_id', user.id)
                .single();

            if (fetchError) {
                console.error('Error fetching investment:', fetchError.message);
                alert('Error fetching investment details. Please try again.');
                return;
            }

            // Fetch last collection time
            const { data: lastCollection, error: collectionError } = await supabase
                .from('collections')
                .select('collected_at')
                .eq('investment_id', investmentId)
                .eq('user_id', user.id)
                .order('collected_at', { ascending: false })
                .limit(1)
                .single();

            const lastCollectionTime = lastCollection ? new Date(lastCollection.collected_at) : new Date(investment.created_at);
            const now = new Date();
            const timeDiff = now - lastCollectionTime;
            const hoursDiff = timeDiff / (1000 * 60 * 60);

            if (hoursDiff < 24) {
                alert('Please wait 24 hours between collections');
                return;
            }

            // Calculate daily returns
            const dailyReturn = parseFloat(investment.daily_returns);

            // Begin transaction
            const { data: collection, error: insertError } = await supabase
                .from('collections')
                .insert([
                    {
                        investment_id: investmentId,
                        user_id: user.id,
                        amount: dailyReturn,
                        collected_at: new Date().toISOString()
                    }
                ]);

            if (insertError) {
                console.error('Error recording collection:', insertError.message);
                alert('Error processing collection. Please try again.');
                return;
            }

            // Update user's wallet balance
            const { data: wallet, error: walletError } = await supabase
                .from('wallets')
                .update({ balance: supabase.raw('balance + ?', [dailyReturn]) })
                .eq('user_id', user.id);

            if (walletError) {
                console.error('Error updating wallet:', walletError.message);
                alert('Error updating wallet balance. Please contact support.');
                return;
            }

            // Show success message
            alert(`Successfully collected ${formatCurrency(dailyReturn)}`);
            
            // Refresh display
            await displayInvestments();
            updateCollectionTimers();
        }

        // Check authentication and initialize
        async function initialize() {
            const user = await getCurrentUser();
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            // Subscribe to real-time updates for investments
            const investmentsSubscription = supabase
                .channel('investments_channel')
                .on('postgres_changes', 
                    {
                        event: '*',
                        schema: 'public',
                        table: 'investments',
                        filter: `user_id=eq.${user.id}`
                    },
                    () => {
                        displayInvestments();
                    }
                )
                .subscribe();

            // Subscribe to collections updates
            const collectionsSubscription = supabase
                .channel('collections_channel')
                .on('postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: 'collections',
                        filter: `user_id=eq.${user.id}`
                    },
                    () => {
                        updateCollectionTimers();
                    }
                )
                .subscribe();

            // Initial display
            await displayInvestments();
            updateCollectionTimers();

            // Update timers every second
            setInterval(() => {
                updateCollectionTimers();
            }, 1000);
        }

        // Start the application
        initialize();
    </script>
</body>
</html>
