<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AfricaBased Admin Control Panel</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabaseClient.js"></script>
    <!-- Add Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background: #181818;
            color: #ffd54f;
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        .control-panel {
            max-width: 1200px;
            margin: 32px auto;
            padding: 24px;
        }
        .header {
            text-align: center;
            margin-bottom: 32px;
            padding: 20px;
            background: #232526;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .admin-status {
            background: #232526;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
        }
        .control-section {
            background: #232526;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
        }
        .section-title {
            color: #ffd54f;
            margin-bottom: 16px;
        }
        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .control-card {
            background: #2c2d2e;
            padding: 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .control-card:hover {
            transform: translateY(-2px);
        }
        .btn {
            background: #ffd54f;
            color: #181818;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }
        .btn:hover {
            background: #ffc107;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
            margin-left: 8px;
        }
        .status-active { background: #4caf50; color: white; }
        .status-inactive { background: #f44336; color: white; }

        .system-controls {
            margin: 20px 0;
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn i {
            font-size: 1.2rem;
        }

        .btn-warning {
            background: #ff9800;
            color: #000;
        }

        .btn-warning:hover {
            background: #f57c00;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn-sync {
            background: #2196f3;
            color: white;
        }

        .btn-sync:hover {
            background: #1976d2;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }
        
        .modal-content {
            background: #232526;
            padding: 24px;
            border-radius: 12px;
            max-width: 500px;
            margin: 100px auto;
        }
        
        .modal-buttons {
            margin-top: 20px;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        .btn-warning {
            background: #ff9800;
        }
        
        .btn-danger {
            background: #f44336;
        }
        
        .btn-sync {
            background: #2196f3;
            color: white;
        }
        
        .sync-status {
            background: #232526;
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
        }
        
        .sync-progress {
            height: 4px;
            background: #333;
            border-radius: 2px;
            margin: 8px 0;
        }
        
        .progress-bar {
            height: 100%;
            width: 0;
            background: #2196f3;
            border-radius: 2px;
            transition: width 0.3s;
        }
        
        .sync-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8em;
            background: #4caf50;
            color: white;
            margin-top: 8px;
        }
        
        .system-controls {
            margin: 20px 0;
            display: flex;
            gap: 12px;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="control-panel">
        <div class="header">
            <h1>Admin Control Panel</h1>
            <div class="system-controls">
                <button class="btn btn-warning" onclick="confirmSystemReset()">
                    <i class="fas fa-redo"></i> Reset System
                </button>
                <button class="btn btn-sync" onclick="syncChanges()">
                    <i class="fas fa-sync"></i> Sync Changes
                </button>
            </div>
        </div>

        <div class="admin-status" id="adminStatus">
            <!-- Admin status will be inserted here -->
        </div>

        <div id="resetConfirmModal" class="modal">
            <div class="modal-content">
                <h2>Confirm System Reset</h2>
                <p>This will reset the entire system. All changes will be synchronized across admin and user panels.</p>
                <p>Please enter your admin security key to confirm:</p>
                <input type="password" id="resetSecurityKey" placeholder="Security Key">
                <div class="modal-buttons">
                    <button class="btn btn-danger" onclick="executeSystemReset()">Confirm Reset</button>
                    <button class="btn" onclick="closeModal('resetConfirmModal')">Cancel</button>
                </div>
            </div>
        </div>

        <div class="sync-status" id="syncStatus" style="display: none;">
            <div class="sync-progress">
                <div class="progress-bar" id="syncProgress"></div>
            </div>
            <p id="syncMessage"></p>
        </div>

        <div class="control-section">
            <h2 class="section-title">User Panel Controls</h2>
            <div class="control-grid">
                <div class="control-card" onclick="navigateToSection('products')">
                    <h3>Products Management</h3>
                    <p>Manage user products, pricing, and visibility</p>
                    <span class="sync-badge" id="productsSyncBadge">Synced</span>
                </div>
                <div class="control-card" onclick="navigateToSection('users')">
                    <h3>User Management</h3>
                    <p>Manage user accounts, permissions, and status</p>
                </div>
                <div class="control-card" onclick="navigateToSection('transactions')">
                    <h3>Transaction Controls</h3>
                    <p>Monitor and manage user transactions</p>
                </div>
                <div class="control-card" onclick="navigateToSection('services')">
                    <h3>Service Controls</h3>
                    <p>Manage available services and features</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let supabase;
        
        // Initialize Supabase client
        async function initializeSupabase() {
            try {
                if (!supabase) {
                    const { createClient } = supabase;
                    supabase = createClient(
                        'https://yoqtahdctzponqkmgkzn.supabase.co',
                        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlvcXRhaGRjdHpwb25xa21na3puIiwicm9sZSI6ImFub24iLCJpYXQiOjE2OTI2NDI1NTEsImV4cCI6MjAwODIxODU1MX0.ZyhK11GBaW0GVlAZJIhS6og7ArA_RAhj2F8OHhAFsys'
                    );
                }
            } catch (error) {
                console.error('Supabase initialization error:', error);
                alert('Failed to initialize database connection');
            }
        }

        // System reset functionality
        async function confirmSystemReset() {
            document.getElementById('resetConfirmModal').style.display = 'block';
        }

        async function executeSystemReset() {
            const securityKey = document.getElementById('resetSecurityKey').value;
            const adminData = JSON.parse(localStorage.getItem('adminData'));
            
            if (securityKey !== adminData.securityKey) {
                alert('Invalid security key');
                return;
            }

            try {
                await initializeSupabase();
                
                // Show sync status
                const syncStatus = document.getElementById('syncStatus');
                const syncProgress = document.getElementById('syncProgress');
                const syncMessage = document.getElementById('syncMessage');
                
                syncStatus.style.display = 'block';
                syncMessage.textContent = 'Resetting system...';

                // Reset tables
                const tables = ['products', 'users', 'transactions', 'services'];
                for (let i = 0; i < tables.length; i++) {
                    syncProgress.style.width = ((i + 1) / tables.length * 100) + '%';
                    syncMessage.textContent = `Resetting ${tables[i]}...`;
                    
                    // Reset table data while preserving structure
                    await supabase.from(tables[i]).delete().not('id', 'is', null);
                }

                // Reset local storage except admin credentials
                const adminAuth = {
                    adminData: localStorage.getItem('adminData'),
                    adminPrivileges: localStorage.getItem('adminPrivileges')
                };
                localStorage.clear();
                localStorage.setItem('adminData', adminAuth.adminData);
                localStorage.setItem('adminPrivileges', adminAuth.adminPrivileges);

                syncMessage.textContent = 'System reset complete!';
                setTimeout(() => {
                    syncStatus.style.display = 'none';
                    closeModal('resetConfirmModal');
                    location.reload();
                }, 2000);

            } catch (error) {
                console.error('Reset error:', error);
                alert('Failed to reset system. Please try again.');
            }
        }

        // Sync changes between admin and user panels
        async function syncChanges() {
            try {
                await initializeSupabase();
                
                const syncStatus = document.getElementById('syncStatus');
                const syncProgress = document.getElementById('syncProgress');
                const syncMessage = document.getElementById('syncMessage');
                
                syncStatus.style.display = 'block';
                syncMessage.textContent = 'Synchronizing changes...';

                // Sync products
                syncProgress.style.width = '25%';
                syncMessage.textContent = 'Syncing products...';
                await syncProducts();

                // Sync users
                syncProgress.style.width = '50%';
                syncMessage.textContent = 'Syncing users...';
                await syncUsers();

                // Sync services
                syncProgress.style.width = '75%';
                syncMessage.textContent = 'Syncing services...';
                await syncServices();

                // Sync transactions
                syncProgress.style.width = '100%';
                syncMessage.textContent = 'Syncing transactions...';
                await syncTransactions();

                syncMessage.textContent = 'All changes synchronized!';
                setTimeout(() => {
                    syncStatus.style.display = 'none';
                    updateSyncBadges();
                }, 2000);

            } catch (error) {
                console.error('Sync error:', error);
                alert('Failed to sync changes. Please try again.');
            }
        }

        // Sync individual components
        async function syncProducts() {
            const { data: adminProducts } = await supabase.from('products').select('*');
            localStorage.setItem('products', JSON.stringify(adminProducts));
            document.getElementById('productsSyncBadge').textContent = 'Synced';
        }

        async function syncUsers() {
            const { data: users } = await supabase.from('users').select('*');
            localStorage.setItem('users', JSON.stringify(users));
        }

        async function syncServices() {
            const { data: services } = await supabase.from('services').select('*');
            localStorage.setItem('services', JSON.stringify(services));
        }

        async function syncTransactions() {
            const { data: transactions } = await supabase.from('transactions').select('*');
            localStorage.setItem('transactions', JSON.stringify(transactions));
        }

        // Update sync status badges
        function updateSyncBadges() {
            const badges = document.querySelectorAll('.sync-badge');
            badges.forEach(badge => {
                badge.textContent = 'Synced';
                badge.style.background = '#4caf50';
            });
        }

        // Modal controls
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Check admin authentication and privileges
        (function checkAdminAuth() {
            try {
                const adminData = JSON.parse(localStorage.getItem('adminData'));
                const adminPrivileges = JSON.parse(localStorage.getItem('adminPrivileges') || '[]');
                
                if (!adminData || !adminData.isLoggedIn) {
                    window.location.href = 'admin-login.html';
                    return;
                }

                // Initialize Supabase
                initializeSupabase();

                // Update admin status display
                const adminStatus = document.getElementById('adminStatus');
                adminStatus.innerHTML = `
                    <h3>Admin Status</h3>
                    <p>Email: ${adminData.email}</p>
                    <p>Privileges: ${adminPrivileges.join(', ')}</p>
                    <p>Last Login: ${new Date(adminData.lastLogin).toLocaleString()}</p>
                    <span class="status-badge status-active">Active</span>
                `;
            } catch (error) {
                console.error('Auth check error:', error);
                window.location.href = 'admin-login.html';
            }
        })();

        // Navigation function with privilege checking
        function navigateToSection(section) {
            const adminPrivileges = JSON.parse(localStorage.getItem('adminPrivileges') || '[]');
            
            // Map sections to required privileges and URLs
            const sectionConfig = {
                products: {
                    privilege: 'product',
                    url: 'admin-product.html'
                },
                users: {
                    privilege: 'user',
                    url: 'admin-user.html'
                },
                transactions: {
                    privilege: 'withdraw',
                    url: 'admin-withdraw.html'
                },
                services: {
                    privilege: 'service',
                    url: 'admin-service.html'
                }
            };

            const config = sectionConfig[section];
            if (!config) {
                console.error('Invalid section:', section);
                return;
            }

            if (!adminPrivileges.includes(config.privilege)) {
                alert('You do not have permission to access this section');
                return;
            }

            window.location.href = config.url;
        }

        // Add event listener for authentication events
        window.addEventListener('storage', function(e) {
            if (e.key === 'adminData' || e.key === 'adminPrivileges') {
                checkAdminAuth();
            }
        });
    </script>
</body>
</html>
