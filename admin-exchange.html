<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Admin Exchange</title>
	<link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
	<style>
		body {
			font-family: 'Roboto', sans-serif;
			background: linear-gradient(135deg, #232526 0%, #ffd54f 100%);
			margin: 0;
			padding: 0;
		}
		.exchange-panel {
			background: #232526;
			border-radius: 12px;
			box-shadow: 0 2px 12px rgba(0,0,0,0.12);
			padding: 32px 24px;
			margin: 40px auto;
			max-width: 600px;
			color: #ffd54f;
		}
		h1 {
			text-align: center;
			color: #ffd54f;
			margin-bottom: 32px;
		}
		.exchange-btn {
			background: #ffd54f;
			color: #232526;
			border: none;
			padding: 12px 28px;
			border-radius: 6px;
			font-size: 1.05rem;
			font-weight: 600;
			cursor: pointer;
			margin-bottom: 8px;
			box-shadow: 0 2px 8px rgba(0,0,0,0.10);
			transition: background 0.2s, color 0.2s;
		}
		.exchange-btn:hover {
			background: #232526;
			color: #ffd54f;
		}
		.code-gen-options {
			display: flex;
			flex-direction: column;
			gap: 12px;
			margin-bottom: 8px;
		}
		.code-gen-btn {
			background: #232526;
			color: #ffd54f;
			border: none;
			padding: 10px 18px;
			border-radius: 5px;
			font-size: 1rem;
			font-weight: 500;
			cursor: pointer;
			box-shadow: 0 2px 6px rgba(0,0,0,0.08);
			transition: background 0.2s, color 0.2s;
		}
		.code-gen-btn:hover {
			background: #ffd54f;
			color: #232526;
		}
		.single-gen-form, .bulk-gen-form, .random-gen-form, .assign-code-panel {
			display: none;
			align-items: center;
			gap: 10px;
			margin: 10px 0 0 0;
		}
		.single-gen-form label, .bulk-gen-form label, .random-gen-form label, .assign-code-panel label {
			color: #ffd54f;
			font-weight: 500;
			margin-right: 6px;
		}
		.single-gen-form input, .bulk-gen-form input, .random-gen-form input, .assign-code-panel input {
			padding: 6px 12px;
			border-radius: 5px;
			border: none;
			background: #232526;
			color: #ffd54f;
			font-size: 1rem;
			width: 100px;
		}
		.codes-table-panel {
			margin: 24px auto;
			max-width: 800px;
			background: #232526;
			border-radius: 12px;
			box-shadow: 0 2px 12px rgba(0,0,0,0.12);
			padding: 24px;
		}
		.codes-table {
			width: 100%;
			border-collapse: collapse;
			background: #232526;
		}
		.codes-table th, .codes-table td {
			border: 1px solid #ffd54f;
			padding: 10px 14px;
			color: #ffd54f;
			text-align: center;
		}
		.codes-table th {
			background: #232526;
			font-weight: 700;
			font-size: 1.05rem;
		}
		.codes-table td button {
			background: #ffd54f;
			color: #232526;
			border: none;
			border-radius: 5px;
			padding: 6px 14px;
			margin: 0 2px;
			font-size: 0.98rem;
			font-weight: 500;
			cursor: pointer;
			transition: background 0.2s, color 0.2s;
		}
		.codes-table td button:hover {
			background: #232526;
			color: #ffd54f;
		}
		/* Reset and Sync Buttons */
		.system-btn {
			padding: 8px 18px;
			border-radius: 6px;
			font-weight: 600;
			cursor: pointer;
			border: none;
			transition: background 0.2s, color 0.2s;
		}
		.btn-reset {
			background: #ff9800;
			color: #000;
		}
		.btn-sync {
			background: #2196f3;
			color: #fff;
		}
		.btn-reset:hover {
			background: #e68900;
		}
		.btn-sync:hover {
			background: #1976d2;
		}
		/* Modal Styles */
		.admin-modal {
			display: none;
			position: fixed;
			z-index: 1000;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.8);
			justify-content: center;
			align-items: center;
		}
		.admin-modal-content {
			background: #232526;
			padding: 24px;
			border-radius: 8px;
			box-shadow: 0 4px 24px rgba(0, 0, 0, 0.12);
			color: #ffd54f;
			max-width: 400px;
			width: 100%;
		}
		.admin-modal h2 {
			margin-top: 0;
		}
		.admin-modal input {
			padding: 10px;
			border-radius: 5px;
			border: none;
			background: #333;
			color: #ffd54f;
			width: calc(100% - 22px);
			margin-bottom: 16px;
		}
		.admin-modal button {
			padding: 10px 18px;
			border-radius: 5px;
			font-weight: 500;
			cursor: pointer;
			border: none;
			transition: background 0.2s, color 0.2s;
		}
		.admin-modal button:hover {
			background: #ffd54f;
			color: #232526;
		}
		/* Sync Status */
		.sync-status {
			display: none;
			background: #232526;
			padding: 16px;
			border-radius: 8px;
			margin: 16px auto;
			max-width: 600px;
		}
		.sync-progress {
			height: 4px;
			background: #333;
			border-radius: 2px;
			margin: 8px 0;
		}
		.progress-bar {
			height: 100%;
			width: 0;
			background: #2196f3;
			border-radius: 2px;
			transition: width 0.3s;
		}
	</style>
</head>
<body>
<!-- Custom Modal for Confirmations and Alerts -->
<div id="customModal" class="admin-modal" style="display:none;">
	<div class="admin-modal-content" id="customModalContent">
		<div id="customModalMessage"></div>
		<div style="margin-top:18px;display:flex;gap:12px;justify-content:flex-end;">
			<button class="system-btn btn-reset" id="customModalOkBtn" style="display:none;">OK</button>
			<button class="system-btn btn-reset" id="customModalYesBtn" style="display:none;">Yes</button>
			<button class="system-btn" id="customModalNoBtn" style="display:none;">No</button>
		</div>
	</div>
</div>
	<!-- Reset/Sync Buttons and Modal -->
	<div style="margin: 24px 0 0 24px; display: flex; align-items: center; gap: 16px;">
		<a href="Admin-panel.html" class="back-btn" style="background:#ffd54f;color:#232526;padding:8px 18px;border-radius:6px;text-decoration:none;font-weight:600;box-shadow:0 2px 8px rgba(0,0,0,0.10);transition:background 0.2s, color 0.2s;">&larr; Back to Admin Panel</a>
		<button class="system-btn btn-reset" onclick="confirmSystemReset()" style="background:#ff9800;color:#000;padding:8px 18px;border-radius:6px;font-weight:600;">Reset</button>
		<button class="system-btn btn-sync" onclick="syncChanges()" style="background:#2196f3;color:#fff;padding:8px 18px;border-radius:6px;font-weight:600;">Sync Changes</button>
	</div>

	<!-- Reset Confirmation Modal -->
	<div id="resetConfirmModal" class="admin-modal" style="display:none;">
		<div class="admin-modal-content">
			<h2>Confirm System Reset</h2>
			<p>This will reset the page and clear all local changes. Enter security key to confirm:</p>
			<input type="password" id="resetSecurityKey" placeholder="Security Key">
			<div style="margin-top:18px;display:flex;gap:12px;justify-content:flex-end;">
				<button class="system-btn btn-reset" onclick="executeSystemReset()">Confirm Reset</button>
				<button class="system-btn" onclick="closeAdminModal()">Cancel</button>
			</div>
		</div>
	</div>

	<!-- Sync Status -->
	<div class="sync-status" id="syncStatus" style="display:none;background:#232526;padding:16px;border-radius:8px;margin:16px auto;max-width:600px;">
		<div class="sync-progress" style="height:4px;background:#333;border-radius:2px;margin:8px 0;">
			<div class="progress-bar" id="syncProgress" style="height:100%;width:0;background:#2196f3;border-radius:2px;transition:width 0.3s;"></div>
		</div>
		<p id="syncMessage"></p>
	</div>

	<h1>Admin Exchange Management</h1>
	<!-- Global Admin Notification Bar -->
	<div id="adminNotificationBar" style="background:#232526;padding:18px 22px;border-radius:10px;margin-bottom:24px;box-shadow:0 2px 8px rgba(255,213,79,0.08);color:#ffd54f;">
		<h3 style="margin-top:0;margin-bottom:10px;color:#ffd54f;">Notifications</h3>
		<ul id="adminNotificationList" style="list-style:none;padding:0;margin:0;"></ul>
	</div>
	<div class="exchange-panel">
	<button class="exchange-btn">Code Generation</button>
		<div class="code-gen-options">
			<button class="code-gen-btn" id="singleGenBtn">Single Code</button>
			<button class="code-gen-btn" id="bulkGenBtn">Bulk Codes</button>
			<button class="code-gen-btn" id="randomGenBtn">Random Codes</button>
			<button class="code-gen-btn" id="referralGenBtn">Referral Reward</button>
			<div id="referralGenForm" class="single-gen-form">
				<label>Amount (Ksh):</label>
				<input type="number" id="referralCodeAmount" min="1" value="50">
				<label>Expiry Date & Time:</label>
				<input type="datetime-local" id="referralCodeExpiry">
				<button id="referralGenSubmit" class="exchange-btn">Generate</button>
			</div>
			<div id="singleGenForm" class="single-gen-form">
				<label>Type:</label>
				<select id="singleCodeType">
				<option value="">Normal Reward</option>
				<option value="referral bonus">Referral Bonus</option>
				<option value="weekly salary">Weekly Salary</option>
				<option value="monthly salary">Monthly Salary</option>
				</select>
				<label>Amount (Ksh):</label>
				<input type="number" id="singleCodeAmount" min="1" value="100">
				<label>Expiry Date & Time:</label>
				<input type="datetime-local" id="singleCodeExpiry">
				<button id="singleGenSubmit" class="exchange-btn">Generate</button>
			</div>
			<div id="randomGenForm" class="random-gen-form">
				<label>Total Pool Amount (Ksh):</label>
				<input type="number" id="randomPoolAmount" min="1" value="1000">
				<label>Number of Users:</label>
				<input type="number" id="randomUserCount" min="1" value="5">
				<label>Highest Amount (Ksh):</label>
				<input type="number" id="randomMaxAmount" min="1" value="500">
				<label>Lowest Amount (Ksh):</label>
				<input type="number" id="randomMinAmount" min="1" value="50">
				<label>Expiry Date & Time:</label>
				<input type="datetime-local" id="randomCodeExpiry">
				<button id="randomGenSubmit" class="exchange-btn">Generate</button>
			</div>
			<div id="bulkGenForm" class="bulk-gen-form">
				<label>Type:</label>
				<select id="bulkCodeType">
				<option value="">Normal Reward</option>
				<option value="referral bonus">Referral Bonus</option>
				<option value="weekly salary">Weekly Salary</option>
				<option value="monthly salary">Monthly Salary</option>
				</select>
				<label>Number of Codes:</label>
				<input type="number" id="bulkCodeCount" min="1" value="10">
				<label>Amount (Ksh):</label>
				<input type="number" id="bulkCodeAmount" min="1" value="100">
				<label>Expiry Date & Time:</label>
				<input type="datetime-local" id="bulkCodeExpiry">
				<button id="bulkGenSubmit" class="exchange-btn">Generate</button>
			</div>
		</div>
		<button class="exchange-btn" id="viewCodesBtn">View Generated Codes</button>
		<div id="codesTablePanel" class="codes-table-panel" style="display:none;">
			<table class="codes-table">
				<thead>
					<tr>
						<th>Code</th>
						<th>Type</th>
						<th>Amount/Pool</th>
						<th>Expiry</th>
						<th>Status</th>
						<th>Actions</th>
					</tr>
				</thead>
				<tbody id="codesTableBody"></tbody>
			</table>
		</div>
		<button class="exchange-btn" id="assignCodeBtn">Assign Code to User</button>
		<div id="assignCodePanel" class="assign-code-panel" style="display:none;">
			<label>User Name/ID:</label>
			<input type="text" id="assignUser" placeholder="Enter user name or ID">
			<label>Amount (Ksh):</label>
			<input type="number" id="assignAmount" min="1" value="100">
			<label>Expiry Date & Time:</label>
			<input type="datetime-local" id="assignExpiry">
			<button id="assignCodeSubmit" class="exchange-btn">Generate & Assign</button>
		</div>
	</div>
	<script>
// --- Custom Modal Logic ---
function showCustomAlert(message, callback) {
	const modal = document.getElementById('customModal');
	const msg = document.getElementById('customModalMessage');
	const okBtn = document.getElementById('customModalOkBtn');
	msg.innerHTML = message;
	okBtn.style.display = 'inline-block';
	document.getElementById('customModalYesBtn').style.display = 'none';
	document.getElementById('customModalNoBtn').style.display = 'none';
	modal.style.display = 'flex';
	okBtn.onclick = function() {
		modal.style.display = 'none';
		if (callback) callback();
	};
}
function showCustomConfirm(message, onYes, onNo) {
	const modal = document.getElementById('customModal');
	const msg = document.getElementById('customModalMessage');
	const yesBtn = document.getElementById('customModalYesBtn');
	const noBtn = document.getElementById('customModalNoBtn');
	msg.innerHTML = message;
	yesBtn.style.display = 'inline-block';
	noBtn.style.display = 'inline-block';
	document.getElementById('customModalOkBtn').style.display = 'none';
	modal.style.display = 'flex';
	yesBtn.onclick = function() {
		modal.style.display = 'none';
		if (onYes) onYes();
	};
	noBtn.onclick = function() {
		modal.style.display = 'none';
		if (onNo) onNo();
	};
}
		// Show/hide forms
		document.getElementById('bulkGenBtn').onclick = function() {
			document.getElementById('bulkGenForm').style.display = 'flex';
			document.getElementById('singleGenForm').style.display = 'none';
			document.getElementById('randomGenForm').style.display = 'none';
			document.getElementById('referralGenForm').style.display = 'none';
			document.getElementById('assignCodePanel').style.display = 'none';
		};
		document.getElementById('randomGenBtn').onclick = function() {
			document.getElementById('randomGenForm').style.display = 'flex';
			document.getElementById('singleGenForm').style.display = 'none';
			document.getElementById('bulkGenForm').style.display = 'none';
			document.getElementById('referralGenForm').style.display = 'none';
			document.getElementById('assignCodePanel').style.display = 'none';
		};
		document.getElementById('singleGenBtn').onclick = function() {
			document.getElementById('singleGenForm').style.display = 'flex';
			document.getElementById('bulkGenForm').style.display = 'none';
			document.getElementById('randomGenForm').style.display = 'none';
			document.getElementById('referralGenForm').style.display = 'none';
			document.getElementById('assignCodePanel').style.display = 'none';
		};
		document.getElementById('referralGenBtn').onclick = function() {
			document.getElementById('referralGenForm').style.display = 'flex';
			document.getElementById('singleGenForm').style.display = 'none';
			document.getElementById('bulkGenForm').style.display = 'none';
			document.getElementById('randomGenForm').style.display = 'none';
			document.getElementById('assignCodePanel').style.display = 'none';
		};
		document.getElementById('referralGenSubmit').onclick = async function() {
			const amount = parseInt(document.getElementById('referralCodeAmount').value);
			const expiry = document.getElementById('referralCodeExpiry').value;
			const code = 'RC-REF-' + generate8CharCode();
			let codes = JSON.parse(localStorage.getItem('redemptionCodes') || '[]');
			let adminCodes = JSON.parse(localStorage.getItem('adminGeneratedCodes') || '[]');
			const codeObj = { code, used: false, type: 'referral', amount, expiry, redeemed: [] };
			codes.push(codeObj);
			adminCodes.push({ code, used: false });
			localStorage.setItem('redemptionCodes', JSON.stringify(codes));
			localStorage.setItem('adminGeneratedCodes', JSON.stringify(adminCodes));

			// Save to Supabase DB
			try {
				// Import supabase client (assumes you have supabaseClient.js in js/)
				const module = await import('./js/supabaseClient.js');
				const supabase = module.supabase;
				const { error } = await supabase.from('reward_codes').insert([
					{
						code: code,
						type: 'referral',
						amount: amount,
						expiry: expiry,
						used: false
					}
				]);
				if (error) {
					showCustomAlert('Referral code saved locally, but failed to save to DB: ' + error.message);
				} else {
					showCustomAlert('Referral reward code generated and saved to DB: ' + code + ' for Ksh ' + amount);
				}
			} catch (e) {
				showCustomAlert('Referral code saved locally, but failed to save to DB: ' + e.message);
			}
			document.getElementById('referralGenForm').style.display = 'none';
		};
		document.getElementById('assignCodeBtn').onclick = function() {
			document.getElementById('assignCodePanel').style.display = 'flex';
			document.getElementById('singleGenForm').style.display = 'none';
			document.getElementById('bulkGenForm').style.display = 'none';
			document.getElementById('randomGenForm').style.display = 'none';
		};
		// 8-character code generator
		function generate8CharCode(type = 'mixed') {
			let chars = '';
			if (type === 'letters') chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
			else if (type === 'digits') chars = '0123456789';
			else chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
			let code = '';
			for (let i = 0; i < 8; i++) {
				code += chars.charAt(Math.floor(Math.random() * chars.length));
			}
			return code;
		}
		function formatDateTime(dt) {
			if (!dt) return 'N/A';
			const d = new Date(dt);
			return d.toLocaleString();
		}
		function getStatus(code) {
			if (code.deactivated) return 'Deactivated';
			if (code.used) return 'Used';
			if (code.type === 'random' && code.redeemed && code.redeemed.length >= code.users) return 'Fully Redeemed';
			return 'Active';
		}
		function renderCodesTable() {
			const codes = JSON.parse(localStorage.getItem('redemptionCodes') || '[]');
			const tbody = document.getElementById('codesTableBody');
			tbody.innerHTML = '';
			codes.forEach((code, idx) => {
				let redeemedInfo = '';
				if (code.redeemed && code.redeemed.length > 0) {
					redeemedInfo = '<br><span style="font-size:0.95em;">';
					code.redeemed.forEach(r => {
						redeemedInfo += `User: ${r.user || 'N/A'} | Amount: Ksh ${r.amount} | Time: ${formatDateTime(r.time)}<br>`;
					});
					redeemedInfo += '</span>';
				}
				let status = getStatus(code);
				if (code.type === 'random' && code.redeemed && code.redeemed.length > 0 && code.redeemed.length < code.users) {
					status = 'Partially Used';
				}
				// Show only the type name as in the dropdown, but change 'Normal Reward' to 'Reward'
				let codeTypeDisplay = '';
				if (code.type === 'single') {
					if (!code.codeType || code.codeType === '' || code.codeType === 'Normal Reward' || code.codeType.toLowerCase() === 'normal reward') {
						codeTypeDisplay = 'Reward';
					} else {
						codeTypeDisplay = code.codeType;
					}
				} else if (code.type === 'random') {
					codeTypeDisplay = 'Random Codes';
				} else if (code.type === 'referral') {
					codeTypeDisplay = 'Referral Reward';
				} else if (code.type === 'user') {
					codeTypeDisplay = 'User Assigned';
				} else {
					codeTypeDisplay = code.type;
				}
				const tr = document.createElement('tr');
				const codeStr = code.code.replace(/^RC-/, '');
				tr.innerHTML = `
					<td style="position:relative;">
						Redemption code: <span class="copy-code-text">${codeStr}</span>
						<button class="copy-btn" title="Copy code" style="background:none;border:none;cursor:pointer;padding:0 0 0 6px;vertical-align:middle;" onclick="copyCodeText(this)">
							<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='#ffd54f' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><rect x='9' y='9' width='13' height='13' rx='2' ry='2'></rect><path d='M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1'></path></svg>
						</button>
					</td>
					<td>${codeTypeDisplay}</td>
					<td>${code.type === 'random' ? 'Pool: Ksh ' + code.pool : 'Ksh ' + (code.amount || '-')}
						${redeemedInfo}
					</td>
					<td>${formatDateTime(code.expiry)}</td>
					<td>${status}</td>
					<td>
						<button onclick="editCode(${idx})">Edit</button>
						<button onclick="deleteCode(${idx})">Delete</button>
						<button onclick="toggleCode(${idx})}">${code.deactivated ? 'Activate' : 'Deactivate'}</button>
					</td>
				`;
				tbody.appendChild(tr);
// Copy only the visible code text in the column
function copyCodeText(btn) {
	const codeSpan = btn.parentElement.querySelector('.copy-code-text');
	if (codeSpan) {
		const code = codeSpan.textContent.trim();
		navigator.clipboard.writeText(code).then(function() {
			showCustomAlert('Code copied to clipboard!');
		}, function() {
			showCustomAlert('Failed to copy code.');
		});
	}
}
			});
		}
		document.getElementById('viewCodesBtn').onclick = function() {
			document.getElementById('codesTablePanel').style.display = 'block';
			renderCodesTable();
		};

		function editCode(idx) {
			showCustomAlert('Edit code functionality coming soon.');
		}
		function deleteCode(idx) {
			let codes = JSON.parse(localStorage.getItem('redemptionCodes') || '[]');
			showCustomConfirm('Delete this code?', function() {
				codes.splice(idx, 1);
				localStorage.setItem('redemptionCodes', JSON.stringify(codes));
				renderCodesTable();
			});
		}
		function toggleCode(idx) {
			let codes = JSON.parse(localStorage.getItem('redemptionCodes') || '[]');
			codes[idx].deactivated = !codes[idx].deactivated;
			localStorage.setItem('redemptionCodes', JSON.stringify(codes));
			renderCodesTable();
		}
		document.getElementById('singleGenSubmit').onclick = function() {
			const amount = parseInt(document.getElementById('singleCodeAmount').value);
			const expiry = document.getElementById('singleCodeExpiry').value;
			const codeType = document.getElementById('singleCodeType').value;
			const code = 'RC-' + generate8CharCode();
			let codes = JSON.parse(localStorage.getItem('redemptionCodes') || '[]');
			let adminCodes = JSON.parse(localStorage.getItem('adminGeneratedCodes') || '[]');
			const codeObj = { code, used: false, type: 'single', codeType, amount, expiry, redeemed: [] };
			codes.push(codeObj);
			adminCodes.push({ code, used: false });
			localStorage.setItem('redemptionCodes', JSON.stringify(codes));
			localStorage.setItem('adminGeneratedCodes', JSON.stringify(adminCodes));
			let msg = 'Single-use redemption code generated: ' + code + ' for Ksh ' + amount;
			if (codeType) msg += ' (' + codeType + ')';
			showCustomAlert(msg);
			document.getElementById('singleGenForm').style.display = 'none';
		};
		document.getElementById('bulkGenSubmit').onclick = function() {
			var count = parseInt(document.getElementById('bulkCodeCount').value);
			var amount = parseInt(document.getElementById('bulkCodeAmount').value);
			var expiry = document.getElementById('bulkCodeExpiry').value;
			var codeType = document.getElementById('bulkCodeType').value;
			var codes = JSON.parse(localStorage.getItem('redemptionCodes') || '[]');
			var adminCodes = JSON.parse(localStorage.getItem('adminGeneratedCodes') || '[]');
			var generated = [];
			for (var i = 0; i < count; i++) {
				var code = 'RC-' + generate8CharCode();
				codes.push({ code, used: false, type: 'single', codeType, amount, expiry, redeemed: [] });
				adminCodes.push({ code, used: false });
				generated.push(code);
			}
			localStorage.setItem('redemptionCodes', JSON.stringify(codes));
			localStorage.setItem('adminGeneratedCodes', JSON.stringify(adminCodes));
			let msg = count + ' single-use codes generated for Ksh ' + amount;
			if (codeType) msg += ' (' + codeType + ')';
			msg += ': ' + generated.join(', ');
			showCustomAlert(msg);
			document.getElementById('bulkGenForm').style.display = 'none';
		};

		document.getElementById('randomGenSubmit').onclick = function() {
			var pool = parseInt(document.getElementById('randomPoolAmount').value);
			var users = parseInt(document.getElementById('randomUserCount').value);
			var max = parseInt(document.getElementById('randomMaxAmount').value);
			var min = parseInt(document.getElementById('randomMinAmount').value);
			var expiry = document.getElementById('randomCodeExpiry').value;
			if (min > max || users * min > pool || max > pool) {
				showCustomAlert('Invalid input. Please check your values.');
				return;
			}
			var amounts = [];
			var remaining = pool;
			for (var i = 0; i < users; i++) {
				var left = users - i;
				var maxForUser = Math.min(max, remaining - min * (left - 1));
				var minForUser = min;
				var amt = left === 1 ? remaining : Math.floor(Math.random() * (maxForUser - minForUser + 1)) + minForUser;
				amounts.push(amt);
				remaining -= amt;
			}
			var code = 'RC-RAND-' + generate8CharCode();
			var codes = JSON.parse(localStorage.getItem('redemptionCodes') || '[]');
			var adminCodes = JSON.parse(localStorage.getItem('adminGeneratedCodes') || '[]');
			codes.push({ code, used: false, type: 'random', pool, users, max, min, amounts, expiry, redeemed: [] });
			adminCodes.push({ code, used: false });
			localStorage.setItem('redemptionCodes', JSON.stringify(codes));
			localStorage.setItem('adminGeneratedCodes', JSON.stringify(adminCodes));
			showCustomAlert('Random code generated: ' + code + '. Redeemable by ' + users + ' users for pool Ksh ' + pool);
			document.getElementById('randomGenForm').style.display = 'none';
		};
		document.getElementById('assignCodeSubmit').onclick = function() {
			const user = document.getElementById('assignUser').value.trim();
			const amount = parseInt(document.getElementById('assignAmount').value);
			const expiry = document.getElementById('assignExpiry').value;
			if (!user) {
				showCustomAlert('Please enter a user name or ID.');
				return;
			}
			const code = 'RC-USER-' + generate8CharCode();
			let codes = JSON.parse(localStorage.getItem('redemptionCodes') || '[]');
			let adminCodes = JSON.parse(localStorage.getItem('adminGeneratedCodes') || '[]');
			codes.push({ code, used: false, type: 'user', amount, expiry, assignedTo: user, redeemed: [] });
			adminCodes.push({ code, used: false });
			localStorage.setItem('redemptionCodes', JSON.stringify(codes));
			localStorage.setItem('adminGeneratedCodes', JSON.stringify(adminCodes));
			showCustomAlert('Code generated and assigned to ' + user + ': ' + code);
			document.getElementById('assignCodePanel').style.display = 'none';
		};

		// --- Reset and Sync Logic ---
		function confirmSystemReset() {
  document.getElementById('resetConfirmModal').style.display = 'flex';
}
function closeAdminModal() {
  document.getElementById('resetConfirmModal').style.display = 'none';
}
function executeSystemReset() {
  const key = document.getElementById('resetSecurityKey').value;
	if (key === '1540568e') {
		// Clear localStorage and reload page
		localStorage.clear();
		sessionStorage.clear();
		location.reload();
	} else {
		showCustomAlert('Incorrect security key.');
	}
}
async function syncChanges() {
  try {
    const syncStatus = document.getElementById('syncStatus');
    const syncProgress = document.getElementById('syncProgress');
    const syncMessage = document.getElementById('syncMessage');
    syncStatus.style.display = 'block';
    syncMessage.textContent = 'Synchronizing changes...';
    // Simulate sync progress
    const steps = ['exchange'];
    for (let i = 0; i < steps.length; i++) {
      syncProgress.style.width = ((i + 1) / steps.length * 100) + '%';
      syncMessage.textContent = `Syncing ${steps[i]}...`;
      await new Promise(resolve => setTimeout(resolve, 500));
    }
    syncMessage.textContent = 'All changes synchronized!';
    setTimeout(() => { syncStatus.style.display = 'none'; }, 2000);
    // Optionally, reload exchange data here
	} catch (error) {
		showCustomAlert('Failed to sync changes. Please try again.');
	}
}
	</script>
</body>
		<script>
		// --- Admin Notification Bar Logic ---
		function renderAdminNotifications() {
			let notifications = [];
			try { notifications = JSON.parse(localStorage.getItem('adminDepositNotifications') || '[]'); } catch {}
			const list = document.getElementById('adminNotificationList');
			if (!list) return;
			if (!notifications.length) {
				list.innerHTML = '<li style="color:#aaa;">No notifications yet.</li>';
				return;
			}
			list.innerHTML = notifications.map(n => {
				let info = `<strong>${n.number || 'N/A'}</strong> tried to deposit <strong>KES ${n.amount || 'N/A'}</strong>`;
				if (n.txid) info += ` (TxID: <span style='color:#ffd54f;'>${n.txid}</span>)`;
				info += ` <span style='font-size:0.95em;color:#aaa;'>[${new Date(n.time).toLocaleString()}]</span>`;
				return `<li style='margin-bottom:8px;'>${info}</li>`;
			}).join('');
		}
		renderAdminNotifications();
		setInterval(renderAdminNotifications, 5000);
		</script>
</html>
