<!-- User Management Table with Profile Picture -->
<div style="margin: 24px 0 0 24px;">
  <a href="Admin-panel.html" class="back-btn" style="background:#ffd54f;color:#232526;padding:8px 18px;border-radius:6px;text-decoration:none;font-weight:600;box-shadow:0 2px 8px rgba(0,0,0,0.10);transition:background 0.2s, color 0.2s;">&larr; Back to Admin Panel</a>
  <button class="system-btn btn-reset" onclick="confirmSystemReset()" style="background:#ff9800;color:#000;padding:8px 18px;border-radius:6px;font-weight:600;">Reset</button>
  <button class="system-btn btn-sync" onclick="syncChanges()" style="background:#2196f3;color:#fff;padding:8px 18px;border-radius:6px;font-weight:600;">Sync Changes</button>
</div>
<div class="dashboard-header">
    <h2>User Management</h2>
    <div class="search-filters">
        <input type="text" id="searchInput" placeholder="Sear// Add jsPDF library
const script = document.createElement('script');
script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
document.head.appendChild(script);

const autoTableScript = document.createElement('script');
autoTableScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js';
document.head.appendChild(autoTableScript);

function exportToCSV() {
    const filteredUsers = searchAndFilterUsers();
    const headers = ['Username', 'User ID', 'Mpesa Number', 'Email', 'Phone', 'Amount Invested', 'Wallet Amount', 'Account Balance', 'Referrals', 'Status'];
    const rows = filteredUsers.map(user => [
        user.username,
        user.id,
        user.mpesa,
        user.email || '-',
        user.phone || '-',
        'Ksh ' + user.invested,
        'Ksh ' + user.wallet,
        'Ksh ' + user.balance,
        user.referrals,
        user.status
    ]);
    const csv = [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const date = new Date().toISOString().split('T')[0];
    a.download = `users-export-${date}.csv`;
    a.click();
}

function exportToPDF() {
    const { jsPDF } = window.jspdf;
    if (!jsPDF) {
        alert('PDF library is still loading. Please try again in a moment.');
        return;
    }

    const filteredUsers = searchAndFilterUsers();
    const doc = new jsPDF();
    
    // Add title
    doc.setFontSize(18);
    doc.text('User Management Report', 14, 20);
    
    // Add date
    doc.setFontSize(12);
    doc.text(`Generated on: ${new Date().toLocaleString()}`, 14, 30);
    
    // Prepare table data
    const headers = [['Username', 'User ID', 'Mpesa', 'Invested', 'Wallet', 'Balance', 'Referrals', 'Status']];
    const data = filteredUsers.map(user => [
        user.username,
        user.id,
        user.mpesa,
        'Ksh ' + user.invested,
        'Ksh ' + user.wallet,
        'Ksh ' + user.balance,
        user.referrals,
        user.status
    ]);
    
    // Add table
    doc.autoTable({
        head: headers,
        body: data,
        startY: 40,
        styles: {
            fontSize: 10,
            cellPadding: 3,
        },
        headStyles: {
            fillColor: [35, 37, 38],
            textColor: [255, 213, 79]
        },
        alternateRowStyles: {
            fillColor: [245, 245, 245]
        },
    });
    
    // Add summary
    const totalUsers = filteredUsers.length;
    const totalInvested = filteredUsers.reduce((sum, user) => sum + user.invested, 0);
    const totalWallet = filteredUsers.reduce((sum, user) => sum + user.wallet, 0);
    
    const finalY = doc.lastAutoTable.finalY || 40;
    doc.setFontSize(12);
    doc.text(`Summary:`, 14, finalY + 10);
    doc.text(`Total Users: ${totalUsers}`, 14, finalY + 20);
    doc.text(`Total Invested: Ksh ${totalInvested}`, 14, finalY + 30);
    doc.text(`Total in Wallets: Ksh ${totalWallet}`, 14, finalY + 40);
    
    // Save the PDF
    const date = new Date().toISOString().split('T')[0];
    doc.save(`user-management-report-${date}.pdf`); class="search-input">
        <select id="statusFilter" class="filter-select">
            <option value="">All Status</option>
            <option value="Active">Active</option>
            <option value="Locked">Locked</option>
        </select>
        <div class="export-buttons">
            <button onclick="exportToCSV()" class="export-btn">Export to CSV</button>
            <button onclick="exportToPDF()" class="export-btn pdf-btn">Export to PDF</button>
        </div>
    </div>
</div>

<div id="userTablePanel" class="user-table-panel" style="display:block;">
    <div class="table-container">
        <table class="user-table">
            <thead>
                <tr>
                    <th onclick="sortTable('profile')">Profile</th>
                <th>Username</th>
                <th>User ID</th>
                <th>Mpesa Number</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Amount Invested</th>
                <th>Wallet Amount</th>
                <th>Account Balance</th>
                <th>Referrals</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="userTableBody"></tbody>
    </table>
</div>
<style>
.user-table-panel {
    margin: 24px auto;
    max-width: 1000px;
    background: #232526;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.12);
    padding: 24px;
    max-height: 520px;
    overflow-y: auto;
}
.user-table {
    width: 100%;
    border-collapse: collapse;
    background: #232526;
}
.user-table th, .user-table td {
    border: 1px solid #ffd54f;
    padding: 10px 14px;
    color: #ffd54f;
    text-align: center;
}
.user-table th {
    background: #232526;
    font-weight: 700;
    font-size: 1.05rem;
}
.user-actions-dropdown {
    background: #232526;
    color: #ffd54f;
    border: 1px solid #ffd54f;
    border-radius: 5px;
    padding: 6px 14px;
    font-size: 0.98rem;
    font-weight: 500;
    cursor: pointer;
}
.user-actions-dropdown option {
    background: #232526;
    color: #ffd54f;
}
.user-profile-img {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #ffd54f;
    background: #232526;
}
.admin-modal {
  position: fixed;
  z-index: 9999;
  left: 0; top: 0; width: 100vw; height: 100vh;
  background: rgba(35,37,38,0.7);
  display: flex; align-items: center; justify-content: center;
}
.admin-modal-content {
  background: #232526;
  color: #ffd54f;
  border-radius: 12px;
  padding: 32px 24px;
  min-width: 320px;
  max-width: 90vw;
  box-shadow: 0 2px 12px rgba(0,0,0,0.18);
  position: relative;
}
.admin-modal-close {
  position: absolute;
  top: 12px; right: 18px;
  font-size: 2rem;
  color: #ffd54f;
  cursor: pointer;
}
.admin-modal-content button {
  background: #ffd54f;
  color: #232526;
  border: none;
  border-radius: 6px;
  padding: 8px 18px;
  font-weight: 600;
  margin-top: 18px;
  cursor: pointer;
}
.admin-modal-content button:hover {
  background: #232526;
  color: #ffd54f;
  border: 1px solid #ffd54f;
}
.admin-modal-content input, .admin-modal-content select {
  padding: 8px 12px;
  border-radius: 6px;
  border: 1px solid #ffd54f;
  background: #232526;
  color: #ffd54f;
  margin-bottom: 12px;
  width: 100%;
}
.impersonation-banner {
  position: fixed;
  top: 0; left: 0; right: 0;
  background: #ffd54f;
  color: #232526;
  padding: 16px 32px;
  font-size: 1.15rem;
  font-weight: 600;
  z-index: 99999;
  display: flex;
  justify-content: center;
  align-items: center;
  box-shadow: 0 2px 8px rgba(0,0,0,0.12);
}
.impersonation-banner button {
  margin-left: 24px;
  background: #232526;
  color: #ffd54f;
  border: none;
  border-radius: 6px;
  padding: 8px 18px;
  font-weight: 600;
  cursor: pointer;
}
.impersonation-banner button:hover {
  background: #ffd54f;
  color: #232526;
  border: 1px solid #232526;
}
</style>
<script>
import supabase from './js/supabaseClient.js';
let users = [];

async function fetchUsersFromDB() {
  // Fetch profiles
  const { data: profiles, error: profilesError } = await supabase
    .from('profiles')
    .select('*');
  if (profilesError) {
    console.error('Error fetching profiles:', profilesError.message);
    return [];
  }

  // Fetch wallet balances
  const { data: wallets, error: walletsError } = await supabase
    .from('user_wallet')
    .select('user_id, balance');
  if (walletsError) {
    console.error('Error fetching wallets:', walletsError.message);
  }

  // Fetch account balances
  const { data: accounts, error: accountsError } = await supabase
    .from('user_account')
    .select('user_id, balance');
  if (accountsError) {
    console.error('Error fetching accounts:', accountsError.message);
  }

  // Fetch investments
  const { data: investments, error: investmentsError } = await supabase
    .from('user_products')
    .select('user_id, amount');
  if (investmentsError) {
    console.error('Error fetching investments:', investmentsError.message);
  }

  // Aggregate data
  return profiles.map(profile => {
    const wallet = wallets?.find(w => w.user_id === profile.id)?.balance || 0;
    const account = accounts?.find(a => a.user_id === profile.id)?.balance || 0;
    const invested = investments?.filter(i => i.user_id === profile.id).reduce((sum, i) => sum + (i.amount || 0), 0) || 0;
    return {
      username: profile.username || profile.email,
      id: profile.id,
      mpesa: profile.mpesa || '-',
      email: profile.email || '-',
      phone: profile.phone || '-',
      invested,
      wallet,
      balance: account,
      referrals: profile.referrals || 0,
      status: profile.status || 'Active',
      profile: profile.avatar_url || 'https://via.placeholder.com/48?text=No+Img'
    };
  });
}

async function initializeUserTable() {
  users = await fetchUsersFromDB();
  renderUserTable(users);
}

document.addEventListener('DOMContentLoaded', initializeUserTable);
function renderUserTable(displayUsers = users) {
    const tbody = document.getElementById('userTableBody');
    tbody.innerHTML = '';
    
    if (displayUsers.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="12" style="text-align: center; padding: 20px;">
                    No users found matching your search criteria
                </td>
            </tr>
        `;
        return;
    }
    users.forEach((user, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><img src='${user.profile || "https://via.placeholder.com/48?text=No+Img"}' class='user-profile-img' alt='Profile'></td>
            <td>${user.username}</td>
            <td>${user.id}</td>
            <td>${user.mpesa}</td>
            <td>${user.email || '-'}</td>
            <td>${user.phone || '-'}</td>
            <td>Ksh ${user.invested}</td>
            <td>Ksh ${user.wallet}</td>
            <td>Ksh ${user.balance}</td>
            <td>${user.referrals}</td>
            <td>${user.status}</td>
            <td>
                <select class='user-actions-dropdown' onchange='handleUserAction(this.value, ${idx})'>
                    <option value=''>Select Action</option>
                    <option value='impersonate'>Impersonate</option>
                    <option value='delete'>Delete</option>
                    <option value='lock'>Lock</option>
                    <option value='unlock'>Unlock</option>
                    <option value='resetPassword'>Reset Password</option>
                    <option value='addProduct'>Add Product</option>
                    <option value='removeProduct'>Remove Product</option>
                    <optgroup label='Wallet'>
                        <option value='creditWallet'>Credit Wallet</option>
                        <option value='deductWallet'>Deduct Wallet</option>
                    </optgroup>
                    <optgroup label='Account'>
                        <option value='deductAccount'>Deduct Account</option>
                    </optgroup>
                    <option value='changeRole'>Change Role</option>
                    <optgroup label='Upgrade/Downgrade'>
                        <option value='upgrade'>Upgrade</option>
                        <option value='downgrade'>Downgrade</option>
                    </optgroup>
                    <optgroup label='Freeze'>
                        <option value='freezeWithdrawal'>Freeze Withdrawal</option>
                        <optgroup label='Services'>
                            <option value='freezeWhatsApp'>Freeze WhatsApp Group</option>
                            <option value='freezeManager'>Freeze Manager Access</option>
                        </optgroup>
                    </optgroup>
                </select>
            </td>
        `;
        tbody.appendChild(tr);
    });
}
// Search and filter functionality
let currentPage = 1;
const itemsPerPage = 10;

function searchAndFilterUsers() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    
    return users.filter(user => {
        const matchesSearch = Object.values(user).some(value => 
            String(value).toLowerCase().includes(searchTerm)
        );
        const matchesStatus = !statusFilter || user.status === statusFilter;
        return matchesSearch && matchesStatus;
    });
}

function updatePagination(filteredUsers) {
    const totalPages = Math.ceil(filteredUsers.length / itemsPerPage);
    const start = (currentPage - 1) * itemsPerPage;
    const paginatedUsers = filteredUsers.slice(start, start + itemsPerPage);
    
    renderUserTable(paginatedUsers);
    updatePaginationControls(totalPages);
}

function updatePaginationControls(totalPages) {
    const controls = document.getElementById('paginationControls');
    controls.innerHTML = `
        <button onclick="changePage(-1)" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>
        <span>Page ${currentPage} of ${totalPages}</span>
        <button onclick="changePage(1)" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>
    `;
}

function changePage(delta) {
    currentPage += delta;
    const filteredUsers = searchAndFilterUsers();
    updatePagination(filteredUsers);
}

function sortTable(column) {
    users.sort((a, b) => {
        if (a[column] < b[column]) return -1;
        if (a[column] > b[column]) return 1;
        return 0;
    });
    const filteredUsers = searchAndFilterUsers();
    updatePagination(filteredUsers);
}

function exportToCSV() {
    const filteredUsers = searchAndFilterUsers();
    const headers = Object.keys(users[0]).join(',');
    const rows = filteredUsers.map(user => Object.values(user).join(','));
    const csv = [headers, ...rows].join('\\n');
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'users-export.csv';
    a.click();
}

// Update event listeners
document.getElementById('searchInput').addEventListener('input', () => {
    currentPage = 1;
    const filteredUsers = searchAndFilterUsers();
    updatePagination(filteredUsers);
});

document.getElementById('statusFilter').addEventListener('change', () => {
    currentPage = 1;
    const filteredUsers = searchAndFilterUsers();
    updatePagination(filteredUsers);
});

// Modal HTML
const modalHtml = `
<div id="adminModal" class="admin-modal" style="display:none;">
  <div class="admin-modal-content">
    <span class="admin-modal-close" onclick="closeAdminModal()">&times;</span>
    <div id="adminModalBody"></div>
  </div>
</div>
<style>
.admin-modal {
  position: fixed;
  z-index: 9999;
  left: 0; top: 0; width: 100vw; height: 100vh;
  background: rgba(35,37,38,0.7);
  display: flex; align-items: center; justify-content: center;
}
.admin-modal-content {
  background: #232526;
  color: #ffd54f;
  border-radius: 12px;
  padding: 32px 24px;
  min-width: 320px;
  max-width: 90vw;
  box-shadow: 0 2px 12px rgba(0,0,0,0.18);
  position: relative;
}
.admin-modal-close {
  position: absolute;
  top: 12px; right: 18px;
  font-size: 2rem;
  color: #ffd54f;
  cursor: pointer;
}
.admin-modal-content button {
  background: #ffd54f;
  color: #232526;
  border: none;
  border-radius: 6px;
  padding: 8px 18px;
  font-weight: 600;
  margin-top: 18px;
  cursor: pointer;
}
.admin-modal-content button:hover {
  background: #232526;
  color: #ffd54f;
  border: 1px solid #ffd54f;
}
.admin-modal-content input, .admin-modal-content select {
  padding: 8px 12px;
  border-radius: 6px;
  border: 1px solid #ffd54f;
  background: #232526;
  color: #ffd54f;
  margin-bottom: 12px;
  width: 100%;
}
</style>
`;
document.body.insertAdjacentHTML('beforeend', modalHtml);

function openAdminModal(contentHtml) {
  document.getElementById('adminModalBody').innerHTML = contentHtml;
  document.getElementById('adminModal').style.display = 'flex';
}
function closeAdminModal() {
  document.getElementById('adminModal').style.display = 'none';
}

function handleUserAction(action, idx) {
  var user = users[idx];
  switch(action) {
    case 'impersonate':
      isImpersonating = true;
      impersonatedUser = user;
      impersonationStartTime = Date.now();
      showImpersonationBanner(user);
      window.location.href = 'home.html?user=' + user.id + '&impersonate=1&start=' + impersonationStartTime;
      break;
    case 'viewProducts':
      window.location.href = 'My-products.html?user=' + user.id + '&impersonate=1';
      break;
    case 'viewProfile':
      window.location.href = 'profile.html?user=' + user.id + '&impersonate=1';
      break;
    case 'goHome':
      window.location.href = 'home.html?user=' + user.id + '&impersonate=1';
      break;
    case 'delete':
      openAdminModal('<h3>Delete User</h3><p>Are you sure you want to delete <strong>' + user.username + '</strong>?</p><button onclick="confirmDeleteUser(' + idx + ')">Delete</button>');
      break;
    case 'lock':
      user.status = 'Locked';
      renderUserTable();
      break;
    case 'unlock':
      user.status = 'Active';
      renderUserTable();
      break;
    case 'resetPassword':
      openAdminModal('<h3>Reset Password</h3><p>Set a new password for <strong>' + user.username + '</strong>:</p><input type="password" id="newPassword"><button onclick="confirmResetPassword(' + idx + ')">Reset</button>');
      break;
    case 'addProduct':
      window.location.href = 'My-products.html?user=' + user.id + '&action=add';
      break;
    case 'removeProduct':
      window.location.href = 'My-products.html?user=' + user.id + '&action=remove';
      break;
    case 'creditWallet':
      openAdminModal('<h3>Credit Wallet</h3><p>Enter amount to credit to <strong>' + user.username + '</strong>:</p><input type="number" id="creditAmount"><button onclick="confirmCreditWallet(' + idx + ')">Credit</button>');
      break;
    case 'deductWallet':
      openAdminModal('<h3>Deduct Wallet</h3><p>Enter amount to deduct from <strong>' + user.username + '</strong>:</p><input type="number" id="deductAmount"><button onclick="confirmDeductWallet(' + idx + ')">Deduct</button>');
      break;
    case 'deductAccount':
      openAdminModal('<h3>Deduct Account</h3><p>Enter amount to deduct from account for <strong>' + user.username + '</strong>:</p><input type="number" id="deductAccAmount"><button onclick="confirmDeductAccount(' + idx + ')">Deduct</button>');
      break;
    case 'changeRole':
      openAdminModal('<h3>Change Role</h3><p>Select new role for <strong>' + user.username + '</strong>:</p><select id="newRole"><option value="user">User</option><option value="admin">Admin</option><option value="manager">Manager</option></select><button onclick="confirmChangeRole(' + idx + ')">Change</button>');
      break;
    case 'upgrade':
      openAdminModal('<h3>Upgrade User</h3><p>Upgrade <strong>' + user.username + '</strong> to premium?</p><button onclick="confirmUpgrade(' + idx + ')">Upgrade</button>');
      break;
    case 'downgrade':
      openAdminModal('<h3>Downgrade User</h3><p>Downgrade <strong>' + user.username + '</strong> to basic?</p><button onclick="confirmDowngrade(' + idx + ')">Downgrade</button>');
      break;
    case 'freezeWithdrawal':
      openAdminModal('<h3>Freeze Withdrawal</h3><p>Freeze withdrawal for <strong>' + user.username + '</strong>?</p><button onclick="confirmFreezeWithdrawal(' + idx + ')">Freeze</button>');
      break;
    case 'freezeWhatsApp':
      openAdminModal('<h3>Freeze WhatsApp Group</h3><p>Freeze WhatsApp group access for <strong>' + user.username + '</strong>?</p><button onclick="confirmFreezeWhatsApp(' + idx + ')">Freeze</button>');
      break;
    case 'freezeManager':
      openAdminModal('<h3>Freeze Manager Access</h3><p>Freeze manager access for <strong>' + user.username + '</strong>?</p><button onclick="confirmFreezeManager(' + idx + ')">Freeze</button>');
      break;
  }
}

function showImpersonationBanner(user) {
  let banner = document.getElementById('impersonationBanner');
  if (!banner) {
    banner = document.createElement('div');
    banner.id = 'impersonationBanner';
    banner.className = 'impersonation-banner';
    document.body.prepend(banner);
  }
  banner.innerHTML = `<strong>Impersonating:</strong> ${user.username} (${user.id}) <button onclick='stopImpersonating()'>Stop Impersonating</button>`;
  banner.style.display = 'block';
}

function stopImpersonation() {
  isImpersonating = false;
  impersonatedUser = null;
  let banner = document.getElementById('impersonationBanner');
  if (banner) banner.style.display = 'none';
  renderUserTable();
}

// Modal action handlers
function confirmDeleteUser(idx) {
  users.splice(idx, 1);
  renderUserTable();
  closeAdminModal();
}
function confirmResetPassword(idx) {
  var newPassword = document.getElementById('newPassword').value;
  if (newPassword) {
    alert('Password reset for ' + users[idx].username + ' to: ' + newPassword);
    closeAdminModal();
  }
}
function confirmCreditWallet(idx) {
  var amount = Number(document.getElementById('creditAmount').value);
  if (amount > 0) {
    users[idx].wallet += amount;
    renderUserTable();
    closeAdminModal();
  }
}
function confirmDeductWallet(idx) {
  var amount = Number(document.getElementById('deductAmount').value);
  if (amount > 0) {
    users[idx].wallet = Math.max(0, users[idx].wallet - amount);
    renderUserTable();
    closeAdminModal();
  }
}
function confirmDeductAccount(idx) {
  var amount = Number(document.getElementById('deductAccAmount').value);
  if (amount > 0) {
    users[idx].balance = Math.max(0, users[idx].balance - amount);
    renderUserTable();
    closeAdminModal();
  }
}
function confirmChangeRole(idx) {
  var newRole = document.getElementById('newRole').value;
  users[idx].role = newRole;
  alert('Role changed for ' + users[idx].username + ' to: ' + newRole);
  closeAdminModal();
}
function confirmUpgrade(idx) {
  users[idx].tier = 'premium';
  alert('User upgraded to premium: ' + users[idx].username);
  closeAdminModal();
}
function confirmDowngrade(idx) {
  users[idx].tier = 'basic';
  alert('User downgraded to basic: ' + users[idx].username);
  closeAdminModal();
}
function confirmFreezeWithdrawal(idx) {
  users[idx].withdrawalFrozen = true;
  alert('Withdrawal frozen for: ' + users[idx].username);
  closeAdminModal();
}
function confirmFreezeWhatsApp(idx) {
  users[idx].whatsappFrozen = true;
  alert('WhatsApp group access frozen for: ' + users[idx].username);
  closeAdminModal();
}
function confirmFreezeManager(idx) {
  users[idx].managerFrozen = true;
  alert('Manager access frozen for: ' + users[idx].username);
  closeAdminModal();
}

// --- Reset and Sync Logic ---
<script src="js/supabaseClient.js"></script>
<script>
// --- Reset and Sync Logic with DB Logging ---
async function logAdminAction(actionType) {
  try {
    const page = 'admin-user';
    let performed_by = null;
    if (localStorage.getItem('adminData')) {
      try {
        performed_by = JSON.parse(localStorage.getItem('adminData')).email;
      } catch (e) {}
    }
    if (window.supabase) {
      await window.supabase.from('admin_actions').insert([
        { action_type: actionType, page, performed_by }
      ]);
    }
  } catch (e) { /* ignore logging errors */ }
}
function confirmSystemReset() {
  document.getElementById('resetConfirmModal').style.display = 'flex';
}
function closeAdminModal() {
  document.getElementById('resetConfirmModal').style.display = 'none';
}
async function executeSystemReset() {
  const key = document.getElementById('resetSecurityKey').value;
  if (key === '1540568e') {
    await logAdminAction('reset');
    localStorage.clear();
    sessionStorage.clear();
    location.reload();
  } else {
    alert('Incorrect security key.');
  }
}
async function syncChanges() {
  try {
    await logAdminAction('sync');
    const syncStatus = document.getElementById('syncStatus');
    const syncProgress = document.getElementById('syncProgress');
    const syncMessage = document.getElementById('syncMessage');
    syncStatus.style.display = 'block';
    syncMessage.textContent = 'Synchronizing changes...';
    const steps = ['users'];
    for (let i = 0; i < steps.length; i++) {
      syncProgress.style.width = ((i + 1) / steps.length * 100) + '%';
      syncMessage.textContent = `Syncing ${steps[i]}...`;
      await new Promise(resolve => setTimeout(resolve, 500));
    }
    syncMessage.textContent = 'All changes synchronized!';
    setTimeout(() => { syncStatus.style.display = 'none'; }, 2000);
    if (typeof fetchUsersFromDB === 'function' && typeof renderUserTable === 'function') {
      users = await fetchUsersFromDB();
      renderUserTable(users);
    }
  } catch (error) {
    alert('Failed to sync changes. Please try again.');
  }
}
</script>
<!-- Sync Status -->
<div class="sync-status" id="syncStatus" style="display:none;background:#232526;padding:16px;border-radius:8px;margin:16px auto;max-width:600px;">
  <div class="sync-progress" style="height:4px;background:#333;border-radius:2px;margin:8px 0;">
    <div class="progress-bar" id="syncProgress" style="height:100%;width:0;background:#2196f3;border-radius:2px;transition:width 0.3s;"></div>
  </div>
  <p id="syncMessage"></p>
</div>
